# IPv4协议

# 1. IPv4 的基本概念

* IPv4是一个网络层协议，用于通过IP地址表示网络中的设备，并确保数据包能够从源设备正确传输到目标设备
* IPv4是一种**无连接**协议，意味着它不保证数据包的传输成功，顺序或可靠性。传输的可靠性依赖上层协议（TCP）
* IPv4地址采用了32位地址空间，可以提供约43亿个地址（具体是4294967296个）

# 2. IPv4地址表示

IPv4采用点分十进制表示：10.10.10.1

IPv4地址结构可以分为三个部分：

* 网络部分：用于标识网络地址

* 主机部分：用于标识主机设备

* 子网掩码：用来区分网络部分和主机部分的边界

  ```
  1  192.168.0.1
  2  |   |   |   |
  3  |   |   |   |-- 第四个字节（1）
  4  |   |   |------ 第三个字节（0）
  5  |   |---------- 第二个字节（168）
  6  |-------------- 第一个字节（192）
  ```

  IPv4可以拆分成两个部分，如果从**192.168.0**拆分，前**24**位都是**网络部分**，后**8**位为**主机部分**。拆分方法由子网掩码决定。这样的拆分方法子网掩码是**255.255.255.0**

# 3. IPv4地址分类

* **A类地址（Class A）**

  地址范围：**0.0.0.0** 到 **127.255.255.255**

  主要用于大型网络，提供大量的主机地址。网络部分占用一个字节，主机部分占用3个字节

  如10.0.0.0（私有地址）

* **B类地址（Class B）**

  地址范围：**128.0.0.0** 到 **191.255.255.255**

  适用于中等规模的网络。网络部分赵勇2个字节，主机部分占用两个字节

  如：**172.16.0.0**

* **C类地址（Class C）**

  地址范围：**192.0.0.0** 到 **223.255.255.255**

  适用于小型网络，网络部分占3个字节，主机部分占用一个字节

* **D类地址（Class D）**

  地址范围：**224.0.0.0** 到 **239.255.255.255**

  用于多播，即数据包发送到多个主机

* **E类地址（Class E）**

  地址范围：**240.0.0.0** 到 **255.255.255.255**

  保留地址，通常不用于常规的互联网通信。

# 4. 子网划分与子网掩码

为了有效地利用IP地址空间，IPv4网络会进行子网划分。子网掩码用于区分IP地址中的网络部分和主机部分。

例如 IP **192.168.0.1** 和子网掩码 **255.255.255.0**。掩码指示前**24**位网络部分，后**8**位是主机部分。

通过子网掩码，可以将一个大的网络分成多个小的子网，检查地址浪费，提高网络效率。

## IP报文结构

![](E:\working\github\nps-learn\手写网络协议栈\image\ipv4报文.png)

**IP数据包要求以4字节对齐**

![](E:\working\github\nps-learn\手写网络协议栈\image\IPv4协议.svg)

## 1. IPv4数据包结构

**IPv4数据包由两部分组成：**

* IP头：包含了IP协议所需要的各种控制信息
* 数据部分：即上层协议（如TCP，UDP）的数据

**IPv4数据包头部结构**

| 字段                                 | 长度（bit） | 描述                                                         |
| ------------------------------------ | ----------- | ------------------------------------------------------------ |
| 版本（Version）                      | 4（位）     | 只是IP协议版本，IPv4为4                                      |
| 头部长度（IHL）                      | 4           | 表示IP头部的长度，单位是32位字（3字节）                      |
| 服务类型（Type of Service）          | 8           | 定义数据包的优先级与服务质量（Qos）                          |
| 总长度（Total Length）               | 16          | 数据包的总长度，包括头部和数据部分                           |
| 标识符（Identification）             | 16          | 唯一表示数据包，用于数据包的分片和重组                       |
| 标志（Flags）                        | 3           | 控制数据包分片的行为（如是否允许分片）                       |
| 片偏移（Fragment Offset）            | 13          | 数据包分片的位置偏移量                                       |
| TTL（Time to Live）                  | 8           | 数据包的最大跳数，防止数据包在网络中无线循环**（给数据包一个生命值）** |
| 协议（Protocol）                     | 8           | 上层协议，表示数据部分使用的协议（如TCP = 6，UDP=17）        |
| 头部校验和（Header Checksum）        | 16          | 用于检验头部是否在传输过程中损坏                             |
| 源IP地址（Source IP Address）        | 32          | 数据包发送者的IP地址                                         |
| 目标IP地址（Destination IP Address） | 32          | 数据包接受者的IP地址                                         |
| 选项（Options）                      | 可选部分    | 可选字段，包括路由选择，时间戳等高级功能                     |
| 填充（Padding）                      | 可选部分    | 填充字节，确保数据包头的长度是32位字的倍数                   |
| 数据部分（Data）                     | 可变长度    | 上层协议的数据，如TCP或UDP的数据部分                         |

## 2. IPv4的数据传输过程

IPv4的传输过程是通过路由器根据目标IP地址来转发数据包的。每个路由器查看数据包的目标IP地址，决定下一个跳点，知道数据包到达目标设备。具体步骤如下

1. 源设备生成数据包，添加目的地的IPv4地址
2. 路由器根据路由表决定数据包的转发路径。
3. 数据包在网络中可能经过多个路由器
4. 目标设备接受到数据包后，根据目标IP地址处理数据。