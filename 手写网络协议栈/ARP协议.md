# ARP协议

ARP（Address Resolution Protocol, 地址解析协议）是一个网络层协议，用于在局域网中（LAN）中**通过已知的IP地址查找对应的MAC地址**（物理地址）。它使得计算机可以在同一个子网内通过IP地址找到目标设备的硬件地址，从而实现数据包的正确传输。

![](E:\working\github\nps-learn\手写网络协议栈\image\ARP协议.svg)

ARP（Address Resolution Protocol）数据包格式定义了ARP协议如何在网络中传输请求和响应信息。ARP数据包的格式被划分为固定长度字段，每个字段有特定的作用。下面是ARP数据包的格式详细。

ARP数据包结构

| 硬件类型                 | 长度（字节） | 描述                                                         |
| ------------------------ | ------------ | ------------------------------------------------------------ |
| **硬件类型（HTYPE）**    | 2            | 指定使用的硬件类型，一般为以太网（Ethernet）对应的**0x0001** |
| **协议类型（PTYPE）**    | 2            | 指定网络协议类型，IPv4协议为0x0800                           |
| **硬件地址长度（HLEN）** | 1            | 指定硬件地址的长度（以字节为单位）,以太网MAC地址为6字节      |
| **协议地址长度（PLEN）** | 1            | 指定协议地址长度(以字节为单位)，IPv4为4字节                  |
| **操作码（OPER）**       | 2            | 指定ARP的操作类型，1表示ARP请求，2表示ARP响应                |
| **发送者硬件地址(SHA)**  | 6            | 发送者的MAC地址                                              |
| **发送者协议地址(SPA)**  | 4            | 发送者的IP地址                                               |
| **目标硬件地址(THA)**    | 6            | 目标的MAC地址（对于ARP请求，此字段为全零）                   |
| **目标协议地址(TPA)**    | 4            | 目标的IP地址                                                 |

# ARP工作原理

## 1. ARP请求

当一台设备需要想同一网络中的其他设备发送数据时，他会首先需要知道目标设备的MAC地址，若设备知道目标的IP地址，但不清楚MAC地址，他会广播一个ARP请求包，内容包括：

这个ARP请求会呗发送倒局域网中的所有设备，应为ARP请求是**广播包**

* 发送设备的IP和MAC地址
* 目标设备的IP地址（但MAC地址未知）

## ARP响应：

所有收到ARP请求的设备会检查目标IP地址。如果某台设备的IP地址与ARP请求中的目标IP匹配，他会返回一个ARP响应包。包含：

这个ARP响应包会**单播**（即只发给请求的设备），是的请求设备能够知道目标设别的MAC地址。

* 目标设备的IP地址
* 目标设备的MAC地址。

## 3. 缓存ARP表

为了避免每次发送数据都要发送ARP请求，设备通常会讲从ARP响应中获取倒的IP和MAC地址映射关系缓存中唉ARP表中，ARP表会定期更新或者在一段时间后过期。

```shell
arp -a // 查看本地arp表
```

![](image\ARP表.jpg)

# ARP用途和ARP攻击

![](image\ARP用途.jpg)

# ARP报文结构

![](image\ARP报文结构.png)

# 1. ARP Request

这是最常见的ARP操作，用于解析某个IP地址对象的MAC地址

* 用途：

  当设备需要向特定IP发送数据，但不知道起对应的MAC地址是，会发送普通的ARP请求。

  设备广播此请求，询问网络中谁拥有改IP地址。

* 操作流程：

  a. 发送方的目标IP地址是需要解析的IP

  b. 目标MAC地址在ARP请求中被填**为全零**

  c. 会以广播形式发送到网络中

  d. 目标设备接受到请求后，返回一个ARP响应，提供其MAC地址。

# 2. Gratuitous ARP (免费的ARP)

Gratuitous ARP 是一种特殊的ARP请求，目的是**验证和更新**网络中的ARP表，而非解析MAC地址。

* 特点：

  Gratuitous ARP 仍然是一个ARP请求包，但它的**目标IP地址 和 源IP地址**相同

  Gratuitous ARP 不许呀响应，目的是让网络中的其他设备更新其ARP缓存。

* 用途

  a. IP冲突检测：

  * 设备在启用一个IP地址时，通过Gratutous ARP 确认改ip是否已经被其他设备使用
  * 如果网络中已有改设备使用此iP，它讲发送Gratuitous ARP 回复，通知冲突

  b. 更新ARP表

  * 当设备的MAC地址发生变化（例如网卡替换）或网络接口移动到不同的交换机接口时，设备可以发送Gratuitous ARP 更新其他设备的ARP表。

  c. 通知网络设备：

  * 用于主动通知网络中其他设备该设备的MAC地址/IP地址对，以减少通信延迟

* 操作流程：

  a. Gratuitous ARP 请求中的MAC地址为广播地址（FF:FF:FF:FF:FF:FF）

  b. 目标IP地址和源IP地址均设备发送方自身的IP。

  c. 网络中所有设备收到Gratuitous ARP包后，会更新其ARP表中的条目

| 特性             | 普通ARP请求             | Gratuitous ARP                   |
| ---------------- | ----------------------- | -------------------------------- |
| **目标IP**       | 目标设别的IP地址        | 自己的IP地址                     |
| **目标MAC**      | 全零（未知）            | 广播地址（FF:FF:FF:FF:FF:FF）    |
| **是否需要响应** | 需要目标设备返回ARP响应 | 不需要响应                       |
| **主要用途**     | 解析目标IP的MAC地址     | IP冲突检测，ARP表更新，MAC通知等 |
| **数据包广播**   | 广播ARP请求             | 广播Gratuitous ARP请求           |
| **典型场景**     | 主机间的正常通信        | 网络初始化，IP/MAC更新，HA心跳等 |

