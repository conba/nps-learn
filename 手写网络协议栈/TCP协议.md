# TCP协议

TCP（Transmission Control Protocol，传输控制协议）是传输层的一种面向连接的。可靠的传输协议，它提供可靠的数据传输，顺序控制，错误校验和流量控制等功能，是实现互联网中最广泛的协议之一。

---

# 1. TCP的主要特点

## （1）面向连接

* 在通信前，必须通过三次握手建立连接，通信完成后通过四次挥手释放连接
* 确保通信双方建立可靠的连接

## （2）可靠传输

* 提供数据确认机制**（ACK）和重传机制**，确保数据正确送达，数据包丢失会重发
* 有序传输：数据报按序号排列，接收方按序组装数据。
* 检测重复和丢包：通过序号和验证数据的完整性。

## （3）字节流传输

* TCP将数据视为**连续的字节流**，而不是独立的报文。
* 应用层数据分割**由TCP负责**，数据边界对应用层不可见。

## （4）流量控制与拥塞控制

* **流量控制：通过滑动窗口防止发送方过快发送数据**
* **拥塞控制：避免因网络拥塞而导致数据丢失或性能下降**

---

# 2. TCP报文结构

![](image\TCP协议.svg)

TCP报文由头部和数据部分组成，其中头部用于传输控制信息

## （1）TCP头部

**TCP头部固定为20字节，可选部分长度不固定，要4字节对齐，具体字段如下：**

| **字段**                            | **长度（位）** | **描述**                                   |
| ----------------------------------- | -------------- | ------------------------------------------ |
| **源端口号**                        | 16             | 发送方的端口号                             |
| **目的端口号**                      | 16             | 接收方的端口号                             |
| **序号（Sequence Number）**         | 32             | 数据流中第一个字节的序号                   |
| **确认号（Acknowledgment Number）** | 32             | 确认接受到的数据的下一个期望字节号         |
| **数据偏移（Data Offset）**         | 4              | TCP头部的长度，单位为4字节                 |
| **保留字段**                        | 6              | 保留，必须为0                              |
| **标志位**                          | 6              | 控制位，包括：SYN，ACK，FIN，RST，PSH，URG |
| **窗口大小（Window size）**         | 16             | 流量控制，用于通告接收方缓冲区大小         |
| **检验和（Checksum）**              | 16             | 检测头部和数据的完整性                     |
| **紧急指针（Urgent Pointer）**      | 16             | 只是紧急数据的位置（仅URG标志位优效）      |
| **可选择段（Options）**             | 可变长度       | 例如最大报文长度（MSS）                    |

## （2）数据 部分

* 包含应用层传输的数据，大小受到最大报文段（MSS）的限制
* MSS由双方协商确定，通常略小于路径MTU（最大传输单元）

# 3. TCP工作原理

## （1）<u>三次握手（建立连接）</u>

三次握手用于建立算个发可靠的通信信道

1. 客户端发送SYN报文（Seq=x），建立请求连接。
2. 服务器收到后回复SYN+ACK报文（seq=y，ACK=x+1）。
3. 客户端收到后发送ACK报文（Seq=x+1，ACK=y+1）。

连接建立后，双方可以开始通信

## （2）<u>数据传输</u>

* TCP使用滑动窗口机制，确保数据按序发送和接收
* 接收方通过ACK确认已收到的数据，未确认的数据将在超时后重传
* 数据按序排列，丢失或乱序的数据包由接收方缓存并重新组装

## （3）<u>四次挥手（释放连接）</u>

四次挥手用于可靠的断开连接

1. 客户端发送FIN报文，表示数据发送完成
2. 服务器回复ACK报文，确认接收FIN
3. 服务器发送FIN报文，通知客户端程序数据发送完毕
4. 客户端回复ACK报文，确认接收服务器的FIN

# 4. TCP的可靠性机制

![](image\tcp可靠性机制.png)

# 5. TCP的优缺点

![](image\TCP优缺点.png)
